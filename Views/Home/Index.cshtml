@using Newtonsoft.Json
@{
    ViewData["Title"] = "Dashboard";
}

@section Styles {
    <link rel="stylesheet" href="/css/dash.css" asp-append-version="true" />
}

<div class="PageFlex">
    <div class="page-header">
        <h1 class="page-title">Dashboard</h1>
        <div class="breadcrumb">
            <a href="#">Analisados</a>
            <span class="separator">/</span>
            <span class="active">Riscos</span>
        </div>
    </div>

    <div class="page-actions">
        <div></div>
        <button class="btn-primary">
            <i class="fas fa-download"></i>
            Download CSV
        </button>
    </div>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon red">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="stat-info">
            <h3>@ViewBag.TotalRiscos</h3>
            <p>Riscos Identificados</p>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon black">
            <i class="fas fa-tools"></i>
        </div>
        <div class="stat-info">
            <h3>@ViewBag.TotalEquipamentos</h3>
            <p>Total de Equipamentos</p>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon red">
            <i class="fas fa-user"></i>
        </div>
        <div class="stat-info">
            <h3>@ViewBag.TotalColaboradores</h3>
            <p>Total de Colaboradores</p>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon yellow">
            <i class="fas fa-file-alt"></i>
        </div>
        <div class="stat-info">
            <h3>@ViewBag.TotalRelatorios</h3>
            <p>Total de Relatórios</p>
        </div>
    </div>
</div>

<div class="dashboard-grid">
    <div class="dashboard-card">
        <div class="card-header">
            <h2 class="card-title">
                <i class="fas fa-chart-bar"></i>
                Taxa de Riscos do ano
            </h2>
            <div class="card-actions">
                <button><i class="fas fa-filter"></i></button>
                <button><i class="fas fa-search"></i></button>
            </div>
        </div>
        <div class="chart-placeholder">
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
        </div>
    </div>

    <div class="dashboard-card">
        <div class="card-header">
            <h2 class="card-title">
                <i class="fas fa-clipboard-list"></i>
                Análises da IA (@ViewBag.MaxAnalisesGeradas)
            </h2>
            <div class="card-actions">
                <button type="button" class="btn-primary" data-action-type="create-modal"
                    data-url="@Url.Action("SelectRisco", "Analises")" data-title="Gerar Nova Análise com IA"
                    data-form-id="selectRiscoForm">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>

        @if (ViewBag.AnalisesUrgentes != null && ViewBag.AnalisesUrgentes.Count > 0)
        {
            <ul class="urgent-list">
                @foreach (var analise in ViewBag.AnalisesUrgentes)
                {
                    <li class="urgent-item">
                        <div class="urgent-item-content">
                            <div class="check-icon">
                                <i class="fas fa-exclamation-triangle text-warning"></i>
                            </div>
                            <p>#@analise.Id | @analise.Risco.Nome - Status: @analise.StatusAnalise</p>
                        </div>
                        <button type="button" class="btn-icon btn-ajax-modal" title="Ver Detalhes" data-id="@analise.Id"
                            data-action-type="details" data-controller-url="@Url.Content("~/Analises")"
                            data-title="Detalhes da Análise #@analise.Id">
                            <i class="fas fa-eye"></i>
                        </button>
                    </li>
                }
            </ul>

            @if (int.TryParse(ViewBag.MaxAnalisesGeradas.ToString(), out int maxAnalises) && maxAnalises > 4)
            {
                <div class="card-footer text-center">
                    <a href="@Url.Action("Index", "Analises")" class="btn btn-sm btn-link">Ver todas as
                        @ViewBag.MaxAnalisesGeradas Análises</a>
                </div>
            }
        }
        else
        {
            <div class="empty-list-message p-3">
                <p>Nenhuma análise recente para ação urgente.</p>
            </div>
        }
    </div>
</div>

<div id="ajax-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h5 id="modalTitle">Título</h5>
            <button id="closeModalButton" type="button" class="btn-close" aria-label="Close">X</button>
        </div>
        <div id="modalBody" class="modal-body"> </div>
    </div>
</div>

@section Scripts {
    <script src="/js/Partialjs.js" asp-append-version="true"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.5.1/chart.min.js"></script> // LINHA MODIFICADA
    <script>
        function getRiscosData() {
            try {
                // A linha abaixo já trata o caso de ser null, mas precisamos garantir que é uma lista de JS
                var data = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.RiscosMensais ?? new List<int>()));

                // Preenche com zeros caso a lista do C# venha incompleta (menos de 12 meses)
                while (data.length < 12) {
                    data.push(0);
                }
                return data;
            } catch (e) {
                console.error("Erro ao serializar ViewBag.RiscosMensais:", e);
                return Array(12).fill(0); // Retorna 12 zeros em caso de erro.
            }
        }
        
        var riscosMensaisData = getRiscosData();
        // Nomes dos meses (Labels)
        var labels = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
        // 1. Substitui o placeholder pela tag <canvas>
        var chartPlaceholder = document.querySelector('.chart-placeholder');
        if (chartPlaceholder) {
            // Remove os divs de placeholder existentes 
            chartPlaceholder.innerHTML = '<canvas id="risksChart"></canvas>';
            // 2. Inicializa o Chart.js SOMENTE se o placeholder existir e for substituído
            const ctx = document.getElementById('risksChart').getContext('2d');
            if (ctx) { // Adiciona verificação se o contexto 2D foi obtido
                 // Define uma altura mínima para o container do gráfico, se necessário.
                chartPlaceholder.style.minHeight = '300px'; // Pode ser necessário ajustar no CSS.
                const risksChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Riscos Identificados',
                            data: riscosMensaisData, // Usa os dados do C#
                            backgroundColor: 'rgba(255, 99, 132, 0.7)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, 
                        scales: {
                            y: {
                                beginAtZero: true,
                                // Garante que o eixo Y exiba apenas números inteiros
                                ticks: {
                                    callback: function(value) { if (value % 1 === 0) { return value; } }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            } else {
                 console.error("Não foi possível obter o contexto 2D para o gráfico.");
            }
        } else {
             console.error("Elemento .chart-placeholder não encontrado.");
        }
    </script>
}